<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mazrix Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      background: #000;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      touch-action: none; /* Prevents double-tap zoom / pinch zoom */
      font-family: Arial, sans-serif;
    }

    #grid {
      flex: 1; /* Grid takes all available space */
      display: grid;
    }

    .cell {
      box-sizing: border-box;
      width: 100%;
      height: 100%;
    }
    .wall { background: #000; }
    .air { background: #fff; }
    .start { background: green; }
    .end { background: red; }
    .player { background: blue; }
    .hidden { background: #000 !important; }

    /* Controls */
    #controls {
      flex-shrink: 0;
      background: #111;
      padding: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .row {
      display: flex;
      justify-content: center;
      margin: 3px 0;
    }
    button {
      width: 50px;
      height: 50px;
      margin: 4px;
      border: none;
      border-radius: 8px;
      background: #222;
      color: #0ff;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 5px #0ff;
      transition: 0.2s;
    }
    button:active {
      background: #0ff;
      color: black;
    }
    .wide {
      width: 110px;
      height: 45px;
      font-size: 1em;
    }
    .back {
      margin-top: 5px;
      width: 100px;
      font-size: 0.9em;
      background: #444;
      color: #fff;
    }
    .back:active {
      background: #888;
      color: black;
    }
  </style>
</head>
<body>

<div id="grid"></div>

<div id="controls">
  <div class="row">
    <button class="wide" onclick="toggleGame()">Start/Stop</button>
    <button class="wide" onclick="toggleFlashlight()">Flashlight</button>
  </div>
  <div class="row">
    <button onclick="movePlayers(0,-1)">▲</button>
  </div>
  <div class="row">
    <button onclick="movePlayers(-1,0)">◀</button>
    <button onclick="movePlayers(1,0)">▶</button>
  </div>
  <div class="row">
    <button onclick="movePlayers(0,1)">▼</button>
  </div>
  <button class="back" onclick="window.location.href='index.html'">Menu</button>
</div>

<script>
  const gridElement = document.getElementById('grid');
  let gridSize = 30; // adjusted smaller to fit mobile better
  let cells = [];
  let players = [];
  let playing = false;
  let flashlightMode = 0; // 0: fullbright, 1: darkness, 2: flashlight
  const flashlightRadius = 5;

  function createGrid(size) {
    gridSize = size;
    gridElement.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
    gridElement.style.gridTemplateRows = `repeat(${size}, 1fr)`;
    gridElement.innerHTML = '';
    cells = [];
    for (let y = 0; y < size; y++) {
      const row = [];
      for (let x = 0; x < size; x++) {
        const cell = document.createElement('div');
        cell.classList.add('cell', 'wall');
        cell.dataset.state = 'wall';
        cell.dataset.x = x;
        cell.dataset.y = y;
        cell.addEventListener('click', () => cycleTile(cell));
        gridElement.appendChild(cell);
        row.push(cell);
      }
      cells.push(row);
    }
  }

  function cycleTile(cell) {
    const state = cell.dataset.state;
    cell.classList.remove(state);
    if (state === 'wall') {
      cell.dataset.state = 'air';
    } else if (state === 'air') {
      cell.dataset.state = 'start';
    } else if (state === 'start') {
      cell.dataset.state = 'end';
    } else {
      cell.dataset.state = 'wall';
    }
    cell.classList.add(cell.dataset.state);
  }

  function startGame() {
    players = [];
    for (let y = 0; y < gridSize; y++) {
      for (let x = 0; x < gridSize; x++) {
        const cell = cells[y][x];
        if (cell.dataset.state === 'start') {
          players.push({x, y});
        }
        cell.classList.remove('player');
      }
    }
    if (players.length === 0) {
      alert("No start tile!");
      return;
    }
    playing = true;
    updatePlayerVisuals();
    updateLighting();
  }

  function stopGame() {
    playing = false;
  }

  function toggleGame() {
    playing ? stopGame() : startGame();
  }

  function toggleFlashlight() {
    flashlightMode = (flashlightMode + 1) % 3;
    updateLighting();
  }

  function updatePlayerVisuals() {
    for (let row of cells) {
      for (let cell of row) {
        cell.classList.remove('player');
      }
    }
    for (let p of players) {
      cells[p.y][p.x].classList.add('player');
    }
  }

  function movePlayers(dx, dy) {
    if (!playing) return;
    players = players.map(p => {
      const nx = p.x + dx;
      const ny = p.y + dy;
      if (nx >= 0 && ny >= 0 && nx < gridSize && ny < gridSize) {
        const next = cells[ny][nx];
        if (next.dataset.state !== 'wall' && !players.some(o => o.x === nx && o.y === ny)) {
          return {x: nx, y: ny};
        }
      }
      return p;
    });
    updatePlayerVisuals();
    updateLighting();
    checkWin();
  }

  function checkWin() {
    const allAtEnd = players.every(p => cells[p.y][p.x].dataset.state === 'end');
    if (allAtEnd && players.length > 0) {
      alert("You win!");
      stopGame();
    }
  }

  function updateLighting() {
    for (let y = 0; y < gridSize; y++) {
      for (let x = 0; x < gridSize; x++) {
        const cell = cells[y][x];
        cell.classList.remove('hidden');
      }
    }

    if (flashlightMode === 0) return; // Fullbright
    if (flashlightMode === 1) {
      for (let row of cells) {
        for (let cell of row) {
          if (cell.dataset.state === 'air') cell.classList.add('hidden');
        }
      }
      return;
    }

    // Mode 2: flashlight effect
    for (let y = 0; y < gridSize; y++) {
      for (let x = 0; x < gridSize; x++) {
        let visible = false;
        for (let p of players) {
          const dx = x - p.x;
          const dy = y - p.y;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (dist <= flashlightRadius && cells[y][x].dataset.state === 'air') {
            visible = true;
            break;
          }
        }
        if (!visible) cells[y][x].classList.add('hidden');
      }
    }
  }

  createGrid(gridSize);
</script>

</body>
</html>
